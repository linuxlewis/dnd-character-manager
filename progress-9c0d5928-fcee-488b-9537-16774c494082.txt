# Progress — Run 9c0d5928-fcee-488b-9537-16774c494082

## Completed Stories

### story-01: Character core types and Zod schemas
- Created `src/domains/character/types/character.ts` with CharacterSchema, CreateCharacterSchema, UpdateCharacterSchema, AbilityScoresSchema, getAbilityModifier
- Created `src/domains/character/types/index.ts` re-exporting all types
- Created `src/domains/character/types/character.test.ts` with 17 passing tests
- All lints and typecheck pass

## Codebase Patterns

- **Domain structure**: `src/domains/<name>/types/` contains Zod schemas, type exports, and tests
- **Schema pattern**: Main schema → CreateSchema (omit id/timestamps) → UpdateSchema (partial of Create)
- **File naming**: `<entity>.ts` for schemas, `<entity>.test.ts` for tests, `index.ts` for re-exports
- **Imports**: Use `.js` extension in imports (ESM)
- **Linting**: biome check + custom `check-deps.ts` for architecture violations
- **Test runner**: vitest
- **Package manager**: pnpm

### story-02: HP and combat types
- Added HpSchema (current min 0, max min 1, temp min 0) to character.ts
- Added hp field to CharacterSchema (and by extension Create/Update schemas)
- Implemented applyDamage (temp HP absorbs first, floors at 0) and applyHealing (caps at max)
- Added 15 new tests covering HpSchema validation, applyDamage, applyHealing with edge cases
- All 36 tests pass, lint and typecheck pass

### story-03: Skills types and proficiency calculation
- Created `src/domains/character/types/skills.ts` with SkillSchema, SKILLS (18 skills), getProficiencyBonus, calculateSkillBonus
- Created `src/domains/character/types/skills.test.ts` with 20 tests covering schema validation, skill count, ability mappings, proficiency bonus for all tier boundaries, and skill bonus calculations
- Updated `index.ts` to re-export all skill types
- All 56 tests pass, lint and typecheck pass

### story-05: Character repository (in-memory)
- Created `src/domains/character/repo/character-repo.ts` with in-memory Map store
- CRUD operations: findAll, findById, create, update, delete (plus _clear for tests)
- create generates UUID via crypto.randomUUID() and sets createdAt/updatedAt
- update merges partial data, preserves id/createdAt, refreshes updatedAt
- Created `src/domains/character/repo/character-repo.test.ts` with 9 tests
- All 77 tests pass, lint and typecheck pass

## Codebase Patterns (updated)

- **Repo pattern**: `src/domains/<name>/repo/<entity>-repo.ts` — in-memory Map store, async methods, exports `<entity>Repo` object
- **Repo test cleanup**: Use `_clear()` helper in beforeEach to reset store between tests

### story-07: HP service methods
- Added `dealDamage(id, amount)` and `healCharacter(id, amount)` to characterService
- Both fetch character, apply HP helpers (applyDamage/applyHealing), persist via repo.update
- Both return null for missing characters
- Added 6 tests: damage reduces HP, damage floors at 0, damage null for missing, heal increases HP, heal caps at max, heal null for missing
- All 93 tests pass, lint and typecheck pass

### story-08: Skill toggle and equipment service methods
- Added `skills` field to CharacterSchema (array of {name, abilityKey, proficient}, default [])
- Added `toggleSkillProficiency(id, skillName)` — finds skill by name, flips proficient boolean
- Added `addEquipment(id, item)` — validates via EquipmentItemSchema, generates UUID, appends to array
- Added `removeEquipment(id, itemId)` — filters equipment array by ID
- All three return null for missing character
- Added 5 tests covering all methods and null cases
- All 99 tests pass, lint and typecheck pass

### story-09: Spell slot service methods
- Added `useSpellSlot(id, level)` — finds slot by level, throws if used >= available, increments used
- Added `restoreSpellSlot(id, level)` — decrements used for given level, floors at 0
- Added `longRest(id)` — resets all spell slots (used = 0)
- All three return null for missing characters
- Added 8 tests covering all methods, edge cases, and null returns
- All 107 tests pass, lint and typecheck pass

### story-11: Action API routes (HP, skills, spells, equipment)
- Added 8 action routes to `src/domains/character/runtime/routes.ts`: damage, heal, skill toggle, add/remove equipment, use/restore spell slot, long-rest
- Added 16 tests in `routes.test.ts` covering all action routes + 404 cases
- All 133 tests pass, lint and typecheck pass
- **Learnings:** EquipmentItemSchema requires `equipped` boolean field; biome auto-fix with `--write` flag

### story-12: React app shell and routing
- Created `src/app/router.tsx` — simple client-side router using History API + useSyncExternalStore
- Created `src/app/router.test.ts` — 5 tests for createRoute pattern matching and param extraction
- Created `src/domains/character/ui/CharacterList.tsx` with CSS module — lists characters, navigates to sheet
- Created `src/domains/character/ui/CharacterSheet.tsx` with CSS module — shows character details with ability scores
- Updated `src/app/app.tsx` to use Router with two routes: / and /character/:id
- Added `host: "0.0.0.0"` to vite config
- Added `src/css-modules.d.ts` for CSS module type declarations
- All 138 tests pass, lint and typecheck pass
- **Learnings:** AbilityScores keys are UPPERCASE (STR, DEX, etc.); biome --fix --unsafe for auto-organizing imports
---

### story-13: Character list UI
- Enhanced CharacterList component with HP display (current/max), "New Character" button, empty state message, mobile-first responsive grid
- Used CSS modules with mobile-first grid (1 col → 2 col → 3 col at breakpoints)
- Changed card from div[role=button] to <button> for biome a11y compliance
- Added 4 tests for component export, API contract shape, empty state, card data fields
- Files changed: CharacterList.tsx, CharacterList.module.css, CharacterList.test.ts
- **Learnings:** biome enforces no div[role=button] — use semantic <button> instead; biome format prefers single-line short JSX text
- All 142 tests pass, lint and typecheck pass
---

### story-14: Create/edit character form
- Created CharacterForm component with name, race, class, level, and 6 ability score fields
- Form validates with CreateCharacterSchema (Zod) before submission
- Create mode POSTs to /api/characters, edit mode PUTs to /api/characters/:id
- Mobile-friendly: min-height 44px inputs, 48px submit button, 2-col ability grid
- Added routes: /character/new and /character/:id/edit in app.tsx
- 8 tests: component export, schema validation (valid, empty name, level bounds, ability score bounds, all 6 abilities)
- All 150 tests pass, lint and typecheck pass
- **Learnings:** biome requires tabs in CSS files; use `biome check --write` to auto-fix formatting
---

### story-15: Character sheet - ability scores and HP
- Enhanced CharacterSheet with HP bar (color-coded: green >50%, yellow >25%, red ≤25%)
- Added damage/heal buttons that prompt for amount and call POST /api/characters/:id/damage and /heal
- UI updates via setCharacter after API response (no full page refresh)
- Added 7 tests: component export, modifier calculation, modifier formatting, HP percentage, HP color thresholds, damage/heal API contracts
- Files changed: CharacterSheet.tsx, CharacterSheet.module.css, CharacterSheet.test.ts
- All 157 tests pass, lint and typecheck pass
---
